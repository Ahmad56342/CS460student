<!DOCTYPE html>
<html>
<head>
    <title>Three.js Assignment 5</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
    <script src="https://mrdoob.github.io/stats.js/build/stats.min.js"></script>
    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.154.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.154.0/examples/jsm/"
        }
    }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { AnaglyphEffect } from 'three/addons/effects/AnaglyphEffect.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { VertexNormalsHelper } from 'three/addons/helpers/VertexNormalsHelper.js';
        import { Pane } from 'https://cdn.jsdelivr.net/npm/tweakpane@4.0.5/dist/tweakpane.min.js';

        let camera, scene, renderer, effect;
        let controls;
        let loader;
        let pane;
        let stats;

        //
        // SETTINGS and HELPER for TWEAKPANE
        //
        window['SCENE'] = {
            'anaglyph': false,
            'poly': null,
            'rotate_poly': false,
            'do_rotate_poly': function() {
                window['SCENE']['rotate_poly'] = !window['SCENE']['rotate_poly'];
            },
            'blender': null,
            'blender_helper': null,
            'rotate_blender': false,
            'do_rotate_blender': function() {
                window['SCENE']['rotate_blender'] = !window['SCENE']['rotate_blender'];
            },
            'blender_old_material': null,
            'change_material': function() {
                if (!window['SCENE']['blender_old_material']) {
                    window['SCENE']['blender_old_material'] = window['SCENE']['blender'].material.clone();
                    window['SCENE']['blender'].material = new THREE.MeshNormalMaterial();
                } else {
                    window['SCENE']['blender'].material = window['SCENE']['blender_old_material'].clone();
                    window['SCENE']['blender_old_material'] = null;
                }
            }
        };

        // Quaternions for rotation
        const identityQuaternion = new THREE.Quaternion();
        const rotationQuaternion = new THREE.Quaternion();
        rotationQuaternion.setFromAxisAngle(new THREE.Vector3(0, 1, 0), Math.PI); // 180 degrees around Y axis

        window.onload = function() {
            // Scene setup
            scene = new THREE.Scene();
            
            // Setup Tweakpane
            pane = new Pane();
            var sceneui = pane.addFolder({
                title: 'Scene',
                expanded: true
            });

            // Add scene controls
            sceneui.addBinding(window.SCENE, 'anaglyph');
            
            // Lights setup
            const ambientLight = new THREE.AmbientLight(0x404040, 1.0); // soft white light
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            // Add light controls
            sceneui.addBinding(directionalLight.position, 'x', {min:-100, max:100, label:'Light X'});
            sceneui.addBinding(directionalLight.position, 'y', {min:-100, max:100, label:'Light Y'});
            sceneui.addBinding(directionalLight.position, 'z', {min:-100, max:100, label:'Light Z'});
            sceneui.addBinding(directionalLight, 'intensity', {min:0, max:2});
            sceneui.addBinding(ambientLight.color, 'r', {min:0, max:1, label:'Ambient R'});
            sceneui.addBinding(ambientLight.color, 'g', {min:0, max:1, label:'Ambient G'});
            sceneui.addBinding(ambientLight.color, 'b', {min:0, max:1, label:'Ambient B'});
            
            // Camera setup
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
            camera.position.set(0, 10, 20);
            camera.lookAt(0, 0, 0);
            
            // Renderer setup
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            
            // Setup controls
            controls = new OrbitControls(camera, renderer.domElement);
            
            // Anaglyph effect setup
            effect = new AnaglyphEffect(renderer);
            effect.setSize(window.innerWidth, window.innerHeight);

            // Setup Stats.js widget
            stats = new Stats();
            document.body.appendChild(stats.domElement);

            // Load unedited PolyCam model
            loader = new GLTFLoader();
            loader.load('poly.glb', function(gltf) {
                scene.add(gltf.scene);
                
                var poly = gltf.scenes[0].children[0];
                poly.scale.x = 10;
                poly.scale.y = 10;
                poly.scale.z = 10;
                
                // Reset rotation with identity quaternion
                poly.quaternion.w = 1;
                poly.quaternion.x = 0;
                poly.quaternion.y = 0;
                poly.quaternion.z = 0;
                
                // Store the poly mesh in our helper
                window.SCENE.poly = poly;

                // Add PolyCam Mesh controls
                var polyui = pane.addFolder({
                    title: 'PolyCam Mesh',
                    expanded: true
                });
                
                // Add wireframe toggle
                polyui.addBinding(window.SCENE.poly.material, 'wireframe');
                
                // Add rotation button
                polyui.addButton({title:'rotate!'}).on('click', () => {
                    window.SCENE.do_rotate_poly();
                });
            });

            // Load edited Blender model
            loader.load('carAssignment5.glb', function(gltf) {
                scene.add(gltf.scene);
                
                var blender = gltf.scenes[0].children[0];
                blender.scale.x = 10;
                blender.scale.y = 10;
                blender.scale.z = 10;
                
                // Reset rotation with identity quaternion
                blender.quaternion.w = 1;
                blender.quaternion.x = 0;
                blender.quaternion.y = 0;
                blender.quaternion.z = 0;
                
                // Store the blender mesh in our helper
                window.SCENE.blender = blender;

                // Create and setup normal helper
                var helper = new VertexNormalsHelper(blender, 0.1, 'blue');
                helper.visible = false;
                scene.add(helper);
                window.SCENE.blender_helper = helper;

                // Add Blender Mesh controls
                var blenderui = pane.addFolder({
                    title: 'Blender Mesh',
                    expanded: true
                });
                
                // Add normal helper toggle
                blenderui.addBinding(helper, 'visible', {label:'Show normals!'});
                
                // Add material change button
                blenderui.addButton({title:'Change Material!'}).on('click', () => {
                    window.SCENE.change_material();
                });

                // Add rotation button
                blenderui.addButton({title:'rotate!'}).on('click', () => {
                    window.SCENE.do_rotate_blender();
                });

                // Move it to the right
                blender.translateX(10);
            });
            
            // Handle window resizing
            window.addEventListener('resize', onWindowResize, false);
            
            // Start animation loop
            animate();
        };

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            effect.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            
            // Update stats
            stats.update();
            
            // Handle poly mesh rotation
            if (window.SCENE.poly) {
                if (window.SCENE.rotate_poly) {
                    window.SCENE.poly.quaternion.slerp(rotationQuaternion, 0.01);
                } else {
                    window.SCENE.poly.quaternion.slerp(identityQuaternion, 0.01);
                }
            }

            // Handle blender mesh rotation
            if (window.SCENE.blender) {
                if (window.SCENE.rotate_blender) {
                    window.SCENE.blender.quaternion.slerp(rotationQuaternion, 0.01);
                } else {
                    window.SCENE.blender.quaternion.slerp(identityQuaternion, 0.01);
                }
                // Update normal helper if it exists
                if (window.SCENE.blender_helper) {
                    window.SCENE.blender_helper.update();
                }
            }
            
            if (window.SCENE.anaglyph) {
                effect.render(scene, camera);
            } else {
                renderer.render(scene, camera);
            }
        }
    </script>
</head>
<body>
</body>
</html>
